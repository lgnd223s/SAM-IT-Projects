import sensor, image, time
from machine import Pin

# Initialize camera
sensor.reset()
sensor.set_pixformat(sensor.RGB565)
sensor.set_framesize(sensor.QVGA)
sensor.skip_frames(time=2000)

# Initialize pins
solenoid = Pin("D3", Pin.OUT)
red_led = Pin("D1", Pin.OUT)
green_led = Pin("D2", Pin.OUT)

# Initial state: locked
solenoid.low()
red_led.high()
green_led.low()

clock = time.clock()

print("SCANNING FOR QR CODE")

while True:
    clock.tick()
    try:
        img = sensor.snapshot()  # This must be called every loop
        codes = img.find_qrcodes()

        if codes:
            print("UNLOCKED")
            solenoid.high()
            red_led.low()
            green_led.high()
            time.sleep_ms(100)
            solenoid.low()
            red_led.high()
            green_led.low()
            time.sleep(2)
            print("SCANNING FOR QR CODE")
    except Exception as e:
        print("Error:", e)
